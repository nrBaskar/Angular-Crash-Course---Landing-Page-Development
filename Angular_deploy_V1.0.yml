---
- name: Staging server Deployment
  hosts: stageserver
  become_user: root
  become: true
  vars:
    repo_path: nrbaskar/angularcourse:{{DOCKER_TAG}}
    dest_path: /home/ec2-user/{{DOCKER_TAG}}
  tasks:
    - name: Install python pip
      yum:
        name: python-pip
        state: present
    - name: Install docker
      yum:
        name: docker
        state: present
    - name: start docker
      service:
        name: docker
        state: started
        enabled: yes
    - name: Install docker-py python module
      pip:
        name: docker-py
        state: present
    - name: Pull docker image
      docker_image:
        name: "{{ repo_path }}"
        tag: "{{ DOCKER_TAG }}"
        source: pull
    - name: create directory
      file:
        path: "{{ dest_path }}"
        state: directory
    - name: copy website to the host
      copy:
        src: ./
        dest: "{{ dest_path }}"
    # Install NodeJS library
    # using multiple shell commands
    - name: Install Node.js 16.x repository
      command: curl -fsSL https://rpm.nodesource.com/setup_16.x | sudo bash -
    # Install required packages
    - name: Install required packages
      yum:
        name: nodejs
        state: present
    # Install Angular CLI
    - name: Install Angular CLI
      command: sudo npm install -g @angular/cli
    # Install project dependencies
    - name: Install project dependencies
      command: npm install
      args:
        chdir: "{{ dest_path }}"
    # Build the application
    - name: Build the application
      command: ng build --prod
      args:
        chdir: "{{ dest_path }}"
    # Install PM2
    - name: Install PM2
      npm:
        name: pm2
        global: yes
    # Stop running processes
    - name: Stop running processes
      command: pm2 kill
      ignore_errors: yes
    # Start the application
    - name: Start the application
      command: pm2 start ./src/index.html --name "{{ DOCKER_TAG }}-Service"
      args:
        chdir: "{{ dest_path }}"
